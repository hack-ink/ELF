# Rust workspace tasks.

# Lint
# | task          | type      | cwd |
# | ------------- | --------- | --- |
# | lint          | composite |     |
# | lint-fix      | composite |     |
# | lint-rust     | command   |     |
# | lint-fix-rust | extend    |     |
# | lint-vstyle   | command   |     |
# | lint-fix-vstyle | command |     |

[tasks.lint]
workspace = false
dependencies = [
	"lint-rust",
	"lint-vstyle",
]

[tasks.lint-fix]
workspace = false
dependencies = [
	"lint-fix-rust",
	"lint-fix-vstyle",
]

[tasks.lint-rust]
workspace = false
command = "cargo"
args = [
	"clippy",
	"--workspace",
	"--all-targets",
	"--all-features",
	"--",
	"-D",
	"warnings",
]

[tasks.lint-fix-rust]
extend = "lint-rust"
args = [
	"clippy",
	"--fix",
	"--allow-dirty",
	"--workspace",
	"--all-targets",
	"--all-features",
]

[tasks.lint-vstyle]
workspace = false
command = "cargo"
args = [
	"vstyle",
	"curate",
	"--workspace",
	"--all-features"
]

[tasks.lint-fix-vstyle]
workspace = false
command = "cargo"
args = [
	"vstyle",
	"tune",
	"--workspace",
	"--all-features",
	"--strict",
]


# Test
# | task      | type      | cwd       |
# | --------- | --------- | ---       |
# | test      | composite |           |
# | test-rust | command   |           |
# | test-all  | composite |           |
# | test-rust-all | command |         |
# | test-integration      | composite |
# | test-integration-rust | command   |

[tasks.test]
workspace = false
dependencies = [
	"test-rust",
]

[tasks.test-rust]
workspace = false
command = "cargo"
args = [
	"nextest",
	"run",
	"--workspace",
	"--all-targets",
	"--all-features",
]

[tasks.test-all]
workspace = false
dependencies = [
	"test-rust-all",
]

[tasks.test-rust-all]
workspace = false
command = "cargo"
args = [
	"nextest",
	"run",
	"--workspace",
	"--all-targets",
	"--all-features",
	"--run-ignored",
	"all",
]

[tasks.test-integration]
workspace = false
dependencies = [
	"test-integration-rust",
]

[tasks.test-integration-rust]
workspace = false
command = "cargo"
args = [
	"nextest",
	"run",
	"--workspace",
	"--all-targets",
	"--all-features",
	"--run-ignored",
	"only",
]


# Format
# | task           | type      | cwd |
# | -------------- | --------- | --- |
# | fmt            | composite |     |
# | fmt-check      | composite |     |
# | fmt-rust       | command   |     |
# | fmt-rust-check | extend    |     |
# | fmt-toml       | command   |     |
# | fmt-toml-check | extend    |     |

[tasks.fmt]
workspace = false
dependencies = [
	"fmt-rust",
	"fmt-toml",
]

[tasks.fmt-check]
workspace = false
dependencies = [
	"fmt-rust-check",
	"fmt-toml-check",
]

[tasks.fmt-rust]
workspace = false
command = "rustup"
args = [
	"run",
	"nightly",
	"cargo",
	"fmt",
	"--all",
]

[tasks.fmt-rust-check]
workspace = false
command = "rustup"
args = [
	"run",
	"nightly",
	"cargo",
	"fmt",
	"--all",
	"--",
	"--check",
]

[tasks.fmt-toml]
workspace = false
command = "taplo"
args = [
	"fmt",
]

[tasks.fmt-toml-check]
extend = "fmt-toml"
args = [
	"fmt",
	"--check",
]

# E2E
# | task                           | type      | cwd |
# | ------------------------------ | --------- | --- |
# | e2e                            | composite |     |
# | e2e-context-misranking-harness | command   |     |

[tasks.e2e]
workspace = false
dependencies = [
	"e2e-context-misranking-harness",
]

[tasks.e2e-context-misranking-harness]
workspace = false
command = "bash"
args = [
	"scripts/context-misranking-harness.sh",
]


# Meta
# | task   | type      | cwd |
# | ------ | --------- | --- |
# | checks | composite |     |

[tasks.checks]
workspace = false
dependencies = [
	"lint",
	"test",
	"fmt-check",
]


# Quality utilities
# | task      | type    | cwd |
# | --------- | ------- | --- |
# | trace-gate | command |     |

[tasks.trace-gate]
workspace = false
command = "bash"
args = [
	"-lc",
	"set -euo pipefail; DSN=\"${TRACE_GATE_PG_DSN:-postgres://postgres:postgres@127.0.0.1:5432/elf}\"; psql \"${DSN}\" -v ON_ERROR_STOP=1 -f sql/init.sql; psql \"${DSN}\" -v ON_ERROR_STOP=1 -f .github/fixtures/trace_gate/fixture.sql; cargo run -p elf-eval --bin trace_regression_gate -- --config .github/fixtures/trace_gate/config.toml --gate .github/fixtures/trace_gate/gate.json --out tmp/trace_gate.report.json",
]
